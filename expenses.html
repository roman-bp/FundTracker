<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–í–∏—Ç—Ä–∞—Ç–∏ ‚Äî –ø–æ –º—ñ—Å—è—Ü—è—Ö</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="top">
  <b>–í–∏—Ç—Ä–∞—Ç–∏ (–ø–æ –º—ñ—Å—è—Ü—è—Ö)</b>
  <button class="btn" onclick="toggleTheme()">üåô / ‚òÄÔ∏è</button>

  <span class="muted">–ö–ª—ñ–∫ –ø–æ –º—ñ—Å—è—Ü—é ‚Üí —Å–ø–∏—Å–æ–∫ –≤–∏—Ç—Ä–∞—Ç + –¥–æ–¥–∞—Ç–∏/–≤–∏–¥–∞–ª–∏—Ç–∏</span>

  <select id="year"></select>
  <button id="reload" class="btn">–û–Ω–æ–≤–∏—Ç–∏</button>

  <a href="index.html" class="btn navbtn">‚Üê –í–Ω–µ—Å–∫–∏</a>
  <a href="balance.html" class="btn navbtn">–ö–∞—Å–∞</a>


  <span id="toast" class="toast"></span>
</div>

<div class="wrap">
  <table id="tbl"></table>
</div>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="card">
    <div class="row">
      <b id="mTitle">–í–∏—Ç—Ä–∞—Ç–∏</b>
      <button id="mClose" class="btn" style="flex:0 0 auto;">–ó–∞–∫—Ä–∏—Ç–∏</button>
    </div>

    <div class="row mt10">
      <input id="spend_date" type="date" />
      <input id="amount" type="number" placeholder="–°—É–º–∞ (–≥—Ä–Ω)" />
      <input id="category" type="text" placeholder="–ö–∞—Ç–µ–≥–æ—Ä—ñ—è (–ø–∞–ª–∏–≤–æ/—ó–∂–∞/—Ä–µ–º–æ–Ω—Ç‚Ä¶)" />
      <input id="note" type="text" placeholder="–ü—Ä–∏–º—ñ—Ç–∫–∞ (–Ω–µ–æ–±–æ–≤ º—è–∑–∫–æ–≤–æ)" />
      <button id="addBtn" class="btn" style="flex:0 0 auto;">–î–æ–¥–∞—Ç–∏</button>
    </div>

    <div class="list" id="list"></div>

    <div class="right mt10">
      <b>–†–∞–∑–æ–º –∑–∞ –º—ñ—Å—è—Ü—å: <span id="mTotal">0</span></b>
    </div>
  </div>
</div>

<script>
const API = "http://jq.zzz.com.ua/api";
const monthNames = ["", "–°—ñ—á", "–õ—é—Ç", "–ë–µ—Ä", "–ö–≤—ñ—Ç", "–¢—Ä–∞–≤", "–ß–µ—Ä", "–õ–∏–ø", "–°–µ—Ä–ø", "–í–µ—Ä", "–ñ–æ–≤—Ç", "–õ–∏—Å—Ç", "–ì—Ä—É–¥"];

const yearSel = document.getElementById("year");
const tbl = document.getElementById("tbl");
const modal = document.getElementById("modal");
const mTitle = document.getElementById("mTitle");
const listBox = document.getElementById("list");
const mTotal = document.getElementById("mTotal");
const spendDate = document.getElementById("spend_date");
const amount = document.getElementById("amount");
const category = document.getElementById("category");
const note = document.getElementById("note");
const addBtn = document.getElementById("addBtn");
const toast = document.getElementById("toast");

let cur = { year: null, month: null };
let adding = false;
let deleting = new Set();

function pad(n){ return String(n).padStart(2,"0"); }
function todayISO(){
  const d = new Date();
  return d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate());
}
function showToast(text){
  toast.textContent = text;
  toast.classList.add("on");
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=>toast.classList.remove("on"), 1600);
}
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

async function getJSON(url){
  const r = await fetch(url, { cache: "no-store" });
  return await r.json();
}
async function postJSON(url, data){
  const r = await fetch(url, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(data),
    cache: "no-store"
  });
  return await r.json();
}

function initYears(){
  const now = new Date().getFullYear();
  const years = [now-1, now, now+1];
  yearSel.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join("");
  yearSel.value = now;
}

function renderTable(monthsObj, grandTotal){
  let html = "<tr><th>–ú—ñ—Å—è—Ü—å</th><th>–í–∏—Ç—Ä–∞—Ç–∏</th></tr>";
  for(let m=1;m<=12;m++){
    const s = monthsObj && monthsObj[m] ? Number(monthsObj[m]) : 0;
    const cls = s ? "cell cell-warn cell-click" : "cell cell-bad cell-click";
    const txt = s ? s : "";
    html += `
      <tr>
        <td class="name">${monthNames[m]}</td>
        <td class="${cls}" data-month="${m}">${txt}</td>
      </tr>
    `;
  }
  html += `<tr><th>–†–∞–∑–æ–º</th><th>${grandTotal ? grandTotal : ""}</th></tr>`;
  tbl.innerHTML = html;
}

async function loadTable(){
  const year = yearSel.value;
  const data = await getJSON(`${API}/expense_matrix.php?year=${year}`);
  if(!data || !data.ok){
    renderTable({}, 0);
    return;
  }
  renderTable(data.months || {}, data.grand_total || 0);
}

async function openMonth(month){
  cur = { year: yearSel.value, month };
  modal.classList.add("on");
  mTitle.textContent = `${monthNames[month]} ${cur.year}`;
  spendDate.value = todayISO();
  amount.value = "";
  category.value = "";
  note.value = "";
  await loadList();
}

async function loadList(){
  const data = await getJSON(`${API}/expense_list.php?year=${cur.year}&month=${cur.month}`);
  if(!data || !data.ok){
    listBox.innerHTML = `<div class="muted">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö.</div>`;
    mTotal.textContent = "0";
    return;
  }

  mTotal.textContent = data.total || 0;

  listBox.innerHTML = (data.items || []).map(i=>{
    const dis = deleting.has(i.id) ? "disabled" : "";
    return `
      <div class="item">
        <div class="item-left">
          <div><b>${escapeHtml(i.spend_date)}</b> ${i.category ? ("‚Äî " + escapeHtml(i.category)) : ""}</div>
          <div class="muted">${i.note ? escapeHtml(i.note) : ""} <span class="muted">id: ${escapeHtml(String(i.id))}</span></div>
        </div>
        <div class="item-right">
          <div><b>${escapeHtml(String(i.amount))}</b></div>
          <button class="btn danger" ${dis} data-del="${i.id}">–í–∏–¥–∞–ª–∏—Ç–∏</button>
        </div>
      </div>
    `;
  }).join("");
}

async function deleteExpense(id){
  if(deleting.has(id)) return;
  if(!confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –≤–∏—Ç—Ä–∞—Ç—É?")) return;

  deleting.add(id);
  await loadList();

  const res = await postJSON(`${API}/expense_delete.php`, { id });

  deleting.delete(id);

  if(res && res.ok){
    showToast("–í–∏–¥–∞–ª–µ–Ω–æ ‚úÖ");
    await loadList();
    await loadTable();
  }else{
    alert(res && res.error ? ("–ü–æ–º–∏–ª–∫–∞: " + res.error) : "–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è");
    await loadList();
  }
}

addBtn.onclick = async ()=>{
  const v = Number(amount.value);
  if(!v || v <= 0) return;

  if(adding) return;
  adding = true;
  addBtn.disabled = true;

  const res = await postJSON(`${API}/expense_add.php`,{
    spend_date: spendDate.value,
    amount: v,
    category: category.value,
    note: note.value
  });

  adding = false;
  addBtn.disabled = false;

  if(res && res.ok){
    showToast("–î–æ–¥–∞–Ω–æ ‚úÖ");
    amount.value = "";
    note.value = "";
    await loadList();
    await loadTable();
  }else{
    alert(res && res.error ? ("–ü–æ–º–∏–ª–∫–∞: " + res.error) : "–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è");
  }
};

/* ‚úÖ –õ–û–í–ò–ú–û –ö–õ–Ü–ö–ò –ù–ê –¢–ê–ë–õ–ò–¶–Ü (–Ω–∞–≤—ñ—Ç—å —è–∫—â–æ onclick –Ω–µ –ø—Ä–∞—Ü—é—î) */
tbl.addEventListener("click", (e)=>{
  const cell = e.target.closest("td[data-month]");
  if(cell){
    const m = Number(cell.dataset.month);
    if(m>=1 && m<=12) openMonth(m);
  }
});

/* ‚úÖ –õ–û–í–ò–ú–û –ö–õ–Ü–ö–ò ‚Äú–í–ò–î–ê–õ–ò–¢–ò‚Äù –í –°–ü–ò–°–ö–£ */
listBox.addEventListener("click", (e)=>{
  const btn = e.target.closest("button[data-del]");
  if(btn){
    const id = Number(btn.dataset.del);
    if(id>0) deleteExpense(id);
  }
});

document.getElementById("mClose").onclick = ()=> modal.classList.remove("on");
document.getElementById("reload").onclick = loadTable;
yearSel.onchange = loadTable;

initYears();
loadTable();
</script>
<script>
function toggleTheme(){
  document.body.classList.toggle('light');

  localStorage.setItem(
    'theme',
    document.body.classList.contains('light') ? 'light' : 'dark'
  );
}

/* –∑–∞–ø–∞–º º—è—Ç–æ–≤—É—î —Ç–µ–º—É */
(function(){
  if(localStorage.getItem('theme') === 'light'){
    document.body.classList.add('light');
  }
})();
</script>

</body>
</html>
